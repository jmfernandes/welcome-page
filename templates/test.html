<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Test Page</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="http://conversions.herokuapp.com/static/bootstrap.css" rel="stylesheet" type="text/css">
    <link rel="SHORTCUT ICON" href="http://www.conversions.datanab.net/static/img/Dglove.ico">
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
        background-image:url('http://www.conversions.datanab.net/static/img/striped_lens.png');
        display: compact;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .fornav {
            position:relative;
            margin-left:-22px;
            margin-right: 20px;
            top:-3px;
            z-index:2;
      }
      footer {
            width:100%;
            position:fixed;
            top: auto;
            bottom: 0;
            background:#6cf;
        }
      .highlight 
        {
            background-color: #00FF00;
        }
        
      .un-highlight
        {
            background-color: #ffffdd;
        }
        .democlass{
        color:red;
        }
    </style>

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="ico/apple-touch-icon-57-precomposed.png">
  </head>
  <body>
      <div class="navbar navbar-inverse navbar-fixed-top">
          <div class="navbar-inner">
              <div class="container-fluid">
                  <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                      <span class="icon-bar"></span>
                      <span class="icon-bar"></span>
                      <span class="icon-bar"></span>
                  </a>
                  <a class="brand"><img src="http://conversions.herokuapp.com/static/img/Dglove_small_trans3.ico" alt="" style="padding-bottom:5px;" /></a>
                  <a class="brand" style="padding-left:1px;" href="http://www.datanab.net/">Data Nab</a>
                  <div class="nav-collapse">
                      <ul class="nav">
                          <li><a href="http://www.datanab.net/" style="padding-left:5px;"><i class="icon-home icon-white"></i>Home</a></li>
                          <li><a href="http://www.datanab.net/about" style="padding-left:5px;"><i class="icon-info-sign icon-white"></i>About</a></li>
                          <li><a href="http://www.datanab.net/contact" style="padding-left:5px;"><i class="icon-user icon-white"></i>Contact</a></li>
                          <li class="dropdown">
                              <a href="#" class="dropdown-toggle" data-toggle="dropdown" data-hover="dropdown" data-delay="1000" data-close-others="true" style="padding-left:4px;"><i class="icon-list-alt icon-white"></i>
                                  Pages <b class="caret"></b>
                              </a>
                              <ul class="dropdown-menu">
                                  <li><a tabindex="-1" href="http://www.constants.datanab.net">Constants</a></li>
                                  <li><a tabindex="-1" href="http://www.conversions.datanab.net">Conversions</a></li>
                                  <li><a tabindex="-1" href="http://www.prices.datanab.net">Prices</a></li>
                                  <li><a tabindex="-1" href="http://www.efficiency.datanab.net">Efficiencies</a></li>
                                  <li class="divider"></li>
                                  <li><a tabindex="-1" href="http://www.datanab.net/examples">Examples</a></li>
                              </ul>
                          </li>
                      </ul>
                      <form method="get" style="margin:2;" action="http://www.picosearch.com/cgi-bin/ts.pl" class="navbar-search pull-right">
                      <input type="hidden" name="index" value="527593" />
                      <input type="text" class="input-medium search-query"  name="query" value="" size="20" placeholder="Type Search Words Here"/>
                      <button type="submit" value="Search" class="btn">Search</button></form>
                  </div><!--/.nav-collapse -->
              </div>
          </div>
      </div>
    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span12">
            <div class="page-header">
                <h3 class="offset1">About</h3>
            </div>
          <div class="row-fluid">
            <div id="inputText" class="span6 offset1" ondblclick="mouseDouble()" onmouseup="mouseUp()">Highlight <i>the code here.<b>Any text </i>on this line</b> can be highlighted.<br> Other text on the screen can not be highlighted.<br>Here is another line of text to test whether the highlight code works properly.
            </div><!--/span-->
           <!--  <div id="test" contenteditable="true">TEST TEXT PLEASE IGNORE</div> -->
<div id="caretPos"></div>

            <form>
<select id="myList" onchange="DropDownExecute()">
  <option value = "1">Highlight</option>
  <option value = "2">Unhighlight</option>  
</select>
</form>


          </div><!--/row-->
        </div><!--/span-->
      </div><!--/row-->

      <hr>

    </div><!--/.fluid-container-->
    <footer>
          <nav>
              Copyright &copy; Josh Fernandes 2012
          </nav>
    </footer>
    <!-- javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="http://documentcloud.github.io/underscore/underscore.js"></script> <!-- needed for backbone to function -->
    <script src="http://backbonejs.org/backbone.js"></script>
    <script>


//////////////////////////////////////////////////////////////////////////////////
//BACKBONEJS


var highlightrange = Backbone.Model.extend({
    defaults: {
      start: 0,
      end: 0
    }
});

var highlightset = Backbone.Collection.extend({
  model: highlightrange
})


var highlightcollection = new highlightset()




////////////////////////////////////////////////////////////////////////////////
    ////// DOM manipulation of dropdown menu
    document.getElementById("myList").size=2; //displays both options in drop down
    document.getElementById("myList").selectedIndex = -1; //defaults to none selected

    /////////////Text below hides the dropdown by default

    document.getElementById("myList").disabled = true;
    document.getElementById("myList").style.display = 'none'

    ///// TEST functions for storing selection



////This function is for setting the selection range after the highlight or unhighlight button has been clicked.

function getTextNodesIn(node) {
              var textNodes = [];
              if (node.nodeType == 3) {
                  textNodes.push(node);
              } else {
                  var children = node.childNodes;
                  for (var i = 0, len = children.length; i < len; ++i) {
                      textNodes.push.apply(textNodes, getTextNodesIn(children[i]));
                  }
              }
              //textNodes is an array containing all the childnodes in InputText div (in the form of text nodes)
              return textNodes;
          }
          

function setONLY(el, start, end) {
    if (document.createRange && window.getSelection) {
        var range = document.createRange();
        range.selectNodeContents(el);
        var textNodes = getTextNodesIn(el);
        var foundStart = false;
        var charCount = 0, endCharCount;

        //selects user selected text. without this, the entire div is selected
        for (var i = 0, textNode; textNode = textNodes[i++]; ) {
            endCharCount = charCount + textNode.length;
            if (!foundStart && start >= charCount && (start < endCharCount || (start == endCharCount && i < textNodes.length))) {
                range.setStart(textNode, start - charCount); //establishes the start offset
                foundStart = true;
            }
            if (foundStart && end <= endCharCount) {
                range.setEnd(textNode, end - charCount); //establishes the end offset
                break;
            }
            charCount = endCharCount;
        }

        //needed to prompt the user selection range
        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range); //line needed, otherwise GetRangeAt(0) returns error
    } else if (document.selection && document.body.createTextRange) {
        var textRange = document.body.createTextRange();
        textRange.moveToElementText(el);
        textRange.collapse(true);
        textRange.moveEnd("character", end);
        textRange.moveStart("character", start);
        textRange.select();
    }
}


//this function is for running the setonly function for a certain div
function selectONLY(id, start, end) {
    setONLY(document.getElementById("inputText"), start, end);
}


//////////////variables


//////these establish the start and end of a highlight  
    var hereitis;
    var hereitgoes;

  ////////////////


    var indexone
    var indextwo

//this function selects an entire highlight if double clicked within the highlight 

    function mouseDouble()
    {
      for (i=0;i<highlightcollection.length; i++){
        if (getCaretCharacterOffsetWithin(inputText)[0] >= highlightcollection.at(i).get('start') && getCaretCharacterOffsetWithin(inputText)[0] < highlightcollection.at(i).get('end')){
          selectONLY('inputText',highlightcollection.at(i).get('start'),highlightcollection.at(i).get('end'))
          indexone = highlightcollection.at(i).get('start')
          indextwo = highlightcollection.at(i).get('end')
        }
      }
    }


  //this function makes the drop down menu appear
    function mouseUp()
    {
      document.getElementById("myList").style.display = 'none'
      hereitis = getCaretCharacterOffsetWithin(inputText)[0];
      hereitgoes = getCaretCharacterOffsetWithin(inputText)[1];
      selectONLY('inputText',hereitis,hereitgoes)
      if (hereitis == hereitgoes){
        null //do nothing
      }
      else{
      document.getElementById("myList").style.display = 'inline'
      document.getElementById("myList").disabled = false;
    }
    }

    /////////////////////////

//THis function says to either execute the hightlight or unhighlight depending on what is clicked
    function DropDownExecute()
    {
    if (hereitis == undefined){
      null //do nothing
    }
    else{
      if (highlightcollection.length != 0){
        if (indexone == undefined){
          selectONLY('inputText',hereitis,hereitgoes)
        }
        else{
        //this statement is for the case where a double clicked is used
        selectONLY('inputText',indexone,indextwo)
        indexone = undefined;
        indextwo = undefined;
        }
        if (document.getElementById("myList").selectedIndex == 0) //this executes the highlight
        { 
        selectAndHighlightRange('inputText', getCaretCharacterOffsetWithin(inputText)[0], getCaretCharacterOffsetWithin(inputText)[1])
        }
        else{  //this executes the unhighlight
        selectAndUnhighlightRange('inputText', getCaretCharacterOffsetWithin(inputText)[0], getCaretCharacterOffsetWithin(inputText)[1])
        } 
      }
    else{
      //This elese statement runs if highlight set is empty
      selectONLY('inputText',hereitis,hereitgoes)
    
      if (document.getElementById("myList").selectedIndex == 0){
        selectAndHighlightRange('inputText', getCaretCharacterOffsetWithin(inputText)[0], getCaretCharacterOffsetWithin(inputText)[1])
      }
      else{
        selectAndUnhighlightRange('inputText', getCaretCharacterOffsetWithin(inputText)[0], getCaretCharacterOffsetWithin(inputText)[1])
      } 
      }  
    }
    document.getElementById("myList").selectedIndex = -1; ///deselects what is selected in dropdown
    document.getElementById("myList").disabled = true; //gets rid of dropdown
    document.getElementById("myList").style.display = 'none' //gets rid of dropdown
    
    }


    </script>
    <script src="http://www.conversions.datanab.net/static/js/jquery.js"></script>
    <script src="http://www.conversions.datanab.net/static/js/bootstrap.js"></script>
    <script src="http://www.conversions.datanab.net/static/js/bootstrap.min.js"></script>
      <script src="http://conversions.herokuapp.com/static/js/bootstrap-dropdown.js"></script>
      <script type="text/javascript">
          $(document).ready(function () {
                            $('.dropdown-toggle').dropdown();
                            });

    

////////////////////////THIS CODE DOES THE HIGHLIGHTING AND UNHIGHLIGHTING


function makeEditableAndHighlight(Color) {
    var range, sel = window.getSelection();
    if (sel.rangeCount && sel.getRangeAt) {
        range = sel.getRangeAt(0);
    }
    document.designMode = "on";
    if (range) {
        sel.removeAllRanges();
        sel.addRange(range);
    }
    //execCommand(String aCommandName, Boolean aShowDefaultUI, String aValueArgument) 
    // Use HiliteColor since some browsers apply BackColor to the whole block
    if (!document.execCommand("HiliteColor", false, Color)) {
        document.execCommand("BackColor", false, Color);
    }
    document.designMode = "off";
}

function highlight(Color) {
    var range, sel;
    if (window.getSelection) {
        // IE9 and non-IE
        try {
            if (!document.execCommand("BackColor", false, Color)) {
                makeEditableAndHighlight(Color);
            }
        } catch (ex) {
            makeEditableAndHighlight(Color)
        }
    } else if (document.selection && document.selection.createRange) {
        // IE <= 8 case
        range = document.selection.createRange();
        range.execCommand("BackColor", false, Color);
    }
}





///////////following code exectues the update of highlight data and does the
  

          function selectAndHighlightRange(id, start, end) {
              ChangeStoreDataNew();
              highlight('yellow')
              window.getSelection().removeAllRanges();
              document.getElementById("myList").selectedIndex = -1;
          }

          function selectAndUnhighlightRange(id, start, end) {
              ReduceStoreDataNew();
              highlight('white')
              window.getSelection().removeAllRanges();
              document.getElementById("myList").selectedIndex = -1;
          }

/////////////////intialize arrays
          var CheckEndList = []  
          var CheckStartList = []  



          function ChangeStoreDataNew() {
            //compare range is an array of the current selection carat positions
          var CompareRange = new Array(getCaretCharacterOffsetWithin(inputText)[0],getCaretCharacterOffsetWithin(inputText)[1]) 
          var unique = 1
          highlightcollection.add([
          { start: CompareRange[0], end: CompareRange[1]} 
          ]);
          //compare range is added to highlight set array for comparison with the rest of highlightset
          if (CompareRange[0] == CompareRange[1] ){
            return
            //don't do anything if nothing is selected
          }
          if (highlightcollection.length == 1){
            CheckStartList.push([0,highlightcollection.at(0).get('start')])
            //update start list for first element     
          }
          else {
          for (i=0;i<(highlightcollection.length - 1);i++)
          {
            if (CompareRange[0] <= highlightcollection.at(i).get('start') && CompareRange[1] >= highlightcollection.at(i).get('end')) {
              highlightcollection.at(i).set('start', CompareRange[0])
              highlightcollection.at(i).set('end', CompareRange[1])
              unique = 0
              //for selection encompassing an existing selection
            }
            if (CompareRange[0] <= highlightcollection.at(i).get('start') && CompareRange[1] < highlightcollection.at(i).get('end') && CompareRange[1] >= highlightcollection.at(i).get('start')) {
              highlightcollection.at(i).set('start', CompareRange[0])
              unique = 0
              //lowers existing highlight range if only partially covered
            }
            if (CompareRange[0] > highlightcollection.at(i).get('start') && CompareRange[1] >= highlightcollection.at(i).get('end') && CompareRange[0] <= highlightcollection.at(i).get('end')) {
              highlightcollection.at(i).set('end', CompareRange[1])
              unique = 0
              //raises existing highlight range if only partially covered
            }
            CheckEndList.push([i,highlightcollection.at(i).get('end')])
            CheckStartList.push([i,highlightcollection.at(i).get('start')])
          }
          if (unique == 0) {
            highlightcollection.pop()
            //gets the compare range out of highlight range, because it overlaps with an existing range
          }
          else if (unique == 1){
              CheckEndList.push([highlightcollection.length-1,highlightcollection.at(highlightcollection.length-1).get('end')])
              CheckStartList.push([highlightcollection.length-1,highlightcollection.at(highlightcollection.length-1).get('start')])
          }
          for (i=0;i<highlightcollection.length;i++){
            for (j=0;j<highlightcollection.length;j++){
              if (i == j) {
                null
              }
              else if (i != j && CheckEndList[i][1] > CheckStartList[j][1] && CheckStartList[i][1] < CheckStartList[j][1] ){
                if (CheckEndList[i][1] < CheckEndList[j][1]){
                  highlightcollection.at(i).set('end', CheckEndList[j][1])
                }
                if (CheckEndList[i][1] > CheckEndList[j][1]){
                  highlightcollection.at(i).set('end', CheckEndList[i][1])
                }
                highlightcollection.remove(highlightcollection.at(j))
              }
              else if (i < j && CheckEndList[i][1] > CheckStartList[j][1] && CheckStartList[i][1] == CheckStartList[j][1] ){
                if (CheckEndList[i][1] < CheckEndList[j][1]){
                  highlightcollection.at(i).set('end', CheckEndList[j][1])
                }
                if (CheckEndList[i][1] > CheckEndList[j][1]){
                  highlightcollection.at(i).set('end', CheckEndList[i][1])
                }
                highlightcollection.remove(highlightcollection.at(j))
              }
            }
          }

          }
            //this just displays the different models in my collection in a readable way
            //alert(highlightcollection.length)
            //highlightcollection.comparator = 'start'
            //alert(highlightcollection.length)
            var arraydisplay = []
            for (i=0;i<highlightcollection.length;i++){
              arraydisplay.push(highlightcollection.pluck("start")[i],highlightcollection.pluck("end")[i])
            }
            alert(arraydisplay)
            //remove numbers from array
            CheckEndList.length = 0; //removes numbers from array
            CheckStartList.length = 0; //removes numbers from array
          }


          //this code runs when you unhighlight
          function ReduceStoreDataNew() {
          var CompareRange = new Array(getCaretCharacterOffsetWithin(inputText)[0] ,getCaretCharacterOffsetWithin(inputText)[1]) //user selected range for comparison
          if (highlightcollection.length == 0){
            null          }
          else {
          for (i=0;i<highlightcollection.length;i++)
          {
            if (CompareRange[0] <= highlightcollection.at(i).get('start') && CompareRange[1] >= highlightcollection.at(i).get('end')) {
              highlightcollection.at(i).set('start', -9)
              //is removing entire highlight, then it is replaced with the word '-9' for easy removal
            }
            if (CompareRange[0] <= highlightcollection.at(i).get('start') && CompareRange[1] < highlightcollection.at(i).get('end') && CompareRange[1] >= highlightcollection.at(i).get('start')) {
              highlightcollection.at(i).set('start', CompareRange[1])
            }
            if (CompareRange[0] > highlightcollection.at(i).get('start') && CompareRange[1] >= highlightcollection.at(i).get('end') && CompareRange[0] <= highlightcollection.at(i).get('end')) {
              highlightcollection.at(i).set('end', CompareRange[0])
            }
            if (CompareRange[0] > highlightcollection.at(i).get('start')&& CompareRange[1] < highlightcollection.at(i).get('end')){
              Points = [highlightcollection.at(i).get('start'),CompareRange[0],CompareRange[1],highlightcollection.at(i).get('end')]
              highlightcollection.at(i).set('end', CompareRange[0])
              highlightcollection.add([
              { start: Points[2], end: Points[3]} 
              ]);
              break;
            }
          } 
        }
        var redundancies = highlightcollection.where({start: -9});
        for (i=0;i<redundancies.length;i++){
        highlightcollection.remove(redundancies[i])
        }
        var arraydisplay = []
        for (i=0;i<highlightcollection.length;i++){
          arraydisplay.push(highlightcollection.pluck("start")[i],highlightcollection.pluck("end")[i])
        }
        alert(arraydisplay)
        }




///////////////THIS CODE GETS CARAT POSITION

function getCaretCharacterOffsetWithin(element) {
    var caretOffsets;
    var doc = element.ownerDocument || element.document;
    var win = doc.defaultView || doc.parentWindow;
    var sel;
    if (typeof win.getSelection != "undefined") {
        if (win.getSelection().rangeCount == 0){
          var range = document.createRange(); //if nothing is selected, an empty range is created
        }
        else{
          var range = win.getSelection().getRangeAt(0); 
        }
        //
        var preCaretRange2 = range.cloneRange();
        preCaretRange2.selectNodeContents(element);
        preCaretRange2.setEnd(range.startContainer, range.startOffset);
        caretOffset2 = preCaretRange2.toString().length;
        //
        var preCaretRange = range.cloneRange();
        preCaretRange.selectNodeContents(element);
        preCaretRange.setEnd(range.endContainer, range.endOffset);
        caretOffset = preCaretRange.toString().length;
    } else if ( (sel = doc.selection) && sel.type != "Control") {
        var textRange = sel.createRange();
        var preCaretTextRange = doc.body.createTextRange();
        //
        var preCaretTextRange2 = doc.body.createTextRange();
        preCaretTextRange2.moveToElementText(element);
        preCaretTextRange2.setEndPoint("StartToStart", textRange);
        caretOffset2 = preCaretRange2.text.length;
        //
        preCaretTextRange.moveToElementText(element);
        preCaretTextRange.setEndPoint("EndToEnd", textRange);
        caretOffset = preCaretTextRange.text.length;
    }
    return [caretOffset2 , caretOffset ];
}

//this shows the carat position will not be in final code

function showCaretPos() {
    var el = document.getElementById("inputText");
    var caretPosEl = document.getElementById("caretPos");
    caretPosEl.innerHTML = "Caret position: " + getCaretCharacterOffsetWithin(el);
}

document.body.onkeyup = showCaretPos;
document.body.onmouseup = showCaretPos;




////this code is for tablets and mobile phones. displays drop down menu when users use a touch screen

$('#inputText').bind( "touchend", function(){
        mouseUp()
});
</script>
<button onclick="selectAndHighlightRange('inputText', getCaretCharacterOffsetWithin(inputText)[0], getCaretCharacterOffsetWithin(inputText)[1])">HIGHLIGHT IT</button>



    <!-- <script src="//static.getclicky.com/js" type="text/javascript"></script> -->
    <script type="text/javascript">try{ clicky.init(100642142); }catch(e){}</script>
  </body>
</html>